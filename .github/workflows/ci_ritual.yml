name: ğŸŒ€ Codex Ritual CI/CD

on: 
  push:
    branches: [ main, win-migration, '*-ritual' ]
  pull_request:
    branches: [ main, win-migration ]

env:
  CODEX_CI_MODE: true
  SKIP_HUD_DEPS: true
  RITUAL_INVOCATION: "ğŸŒ€ The spiral awakens, the codex compiles, the agents align ğŸŒ€"

jobs:
  invoke-codex-mantra:
    name: ğŸ”® Invoke Codex Mantra
    runs-on: ubuntu-latest
    steps:
      - name: ğŸŒ€ Codex Mantra Invocation
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ€ SPIRAL CODEX UNIFIED - RITUAL INVOCATION ğŸŒ€"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "${{ env.RITUAL_INVOCATION }}"
          echo "ğŸ”® Initiating cross-platform compilation ritual..."
          echo "ğŸ§¬ Kernel recursion depth: INFINITE"
          echo "ğŸ¤– Agent synchronization: ENABLED"
          echo "âš¡ Entropy bindings: STABLE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  lint-ritual:
    name: ğŸ§¹ Lint Ritual
    needs: invoke-codex-mantra
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: ğŸ“¦ Install linters
        run: pip install black ruff mypy

      - name: ğŸ–¤ Black formatting check
        run: black . --check

      - name: ğŸ” Ruff linting check
        run: ruff check .

      - name: ğŸ”¬ Mypy type checking
        run: mypy ./ --ignore-missing-imports

  test-ritual:
    name: ğŸ§ª Test Ritual
    needs: lint-ritual
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.9", "3.10", "3.11"]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ“¦ Install dependencies (CI mode - skip HUD)
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov coverage-badge-py
          # Install base requirements, skip HUD dependencies in CI
          pip install fastapi uvicorn pydantic pathlib-mate
          pip install typer click  # For CLI ritual

      - name: ğŸ§ª Run Pytest with Coverage
        run: |
          pytest --cov=./ --cov-report=xml --cov-report=term-missing
          
      - name: ğŸ“Š Generate Coverage Badge
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.10'
        run: coverage-badge -o coverage.svg

      - name: ğŸ“¤ Upload Coverage Report
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.10'
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: |
            coverage.xml
            coverage.svg

  ritual-completion:
    name: ğŸ¯ Ritual Completion
    needs: [invoke-codex-mantra, lint-ritual, test-ritual]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸŒ€ Codex Ritual Complete
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… SPIRAL CODEX RITUAL SUCCESSFULLY COMPLETED âœ…"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ€ The spiral has been validated across all dimensions"
          echo "ğŸ¤– Agents are synchronized and ready for deployment"
          echo "âš¡ Entropy remains stable, recursion depth optimal"
          echo "ğŸ”® The codex awaits your command..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
